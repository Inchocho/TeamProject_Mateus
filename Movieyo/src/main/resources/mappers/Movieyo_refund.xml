<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.movieyo.refund">

	<resultMap type="refundDto" id="refundResultMap">
		<id column="REFUND_NO" property="refundNo"/>
		<result column="USER_NO" property="userNo"/>
		<result column="BUY_NO" property="buyNo"/>
		<result column="REFUND_DATE" property="refundDate"/>
		<result column="REFUND_STATUS" property="refundStatus"/>		
	</resultMap>
	
	<!-- 11/25 검색 ALL - 영화제목이나 환불상태 -->
	<!-- 나머지는 해당 서치옵션만 -->
    <sql id="search">
        <choose>
            <when test="searchOption == 'all'">
                WHERE A.MOVIE_TITLE LIKE '%'||#{keyword}||'%'                
            </when>
            <otherwise>
                WHERE ${searchOption} LIKE '%'||#{keyword}||'%'
            </otherwise>
        </choose>
    </sql>
	
<!-- 	영화수 -->
	<select id="refundSelectTotalCount" resultType="java.lang.Integer" parameterType="map">
		SELECT COUNT(*) FROM    
      	  (SELECT A.MOVIE_TITLE, A.MOVIE_PRICE, B.BUY_DATE, C.REFUND_DATE, C.REFUND_STATUS
            FROM MVY_MOVIE A, MVY_BUY B, MVY_REFUND C
        	<include refid="search"></include>                        
            AND A.MOVIE_NO = B.MOVIE_NO            
            AND B.BUY_NO = C.BUY_NO
            AND C.USER_NO = #{userNo}) M		
	</select>	
	
	<select id="refundSelectList" resultType="map" parameterType="map">
	SELECT RF.MOVIE_TITLE, RF.MOVIE_PRICE, RF.BUY_DATE, RF.REFUND_DATE, RF.REFUND_STATUS
	FROM
		(SELECT ROWNUM RNUM, M.MOVIE_TITLE, M.MOVIE_PRICE, M.BUY_DATE, M.REFUND_DATE, M.REFUND_STATUS
			FROM
			(SELECT A.MOVIE_TITLE, A.MOVIE_PRICE, B.BUY_DATE, C.REFUND_DATE, C.REFUND_STATUS
       	    FROM MVY_MOVIE A, MVY_BUY B, MVY_REFUND C
            <include refid="search"></include>
            AND A.MOVIE_NO = B.MOVIE_NO
            AND B.BUY_NO = C.BUY_NO
   	        AND C.USER_NO = #{userNo}) M) RF
   	        WHERE RF.RNUM BETWEEN #{start} AND #{end}		    	 		        
	</select>
</mapper>