<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.movieyo.movie">

	<resultMap type="movieDto" id="movieResultMap">
		<id column="MOVIE_NO" property="movieNo"/>
		<result column="MOVIE_TITLE" property="movieTitle"/>
		<result column="MOVIE_PRDTYEAR" property="prdtYear"/>
		<result column="MOVIE_NATION" property="nation"/>
		<result column="MOVIE_DIRECTOR" property="director"/>
		<result column="MOVIE_RUNTIME" property="runtime"/>
		<result column="MOVIE_GRADE" property="grade"/>
		<result column="MOVIE_PRICE" property="price"/>
		<result column="MOVIE_CREDATE" property="creDate"/>
		<result column="MOVIE_MODDATE" property="modDate"/>
		<result column="MOVIE_RATE" property="rate"/>
	</resultMap>

	<sql id="search">
		<choose>
			<when test="searchOption == 'all'">
				WHERE MOVIE_DIRECTOR LIKE '%'||#{keyword}||'%'
				OR MOVIE_TITLE LIKE '%'||#{keyword}||'%'
			</when>
			<otherwise>
				WHERE ${searchOption} LIKE '%'||#{keyword}||'%'
			</otherwise>
		</choose>
	</sql>

	<!-- 영화 추가 -->
	<insert id="movieInsertOne" parameterType="com.movieyo.movie.dto.MovieDto"
	useGeneratedKeys="true" keyProperty="movieNo">
		
		<selectKey keyProperty="movieNo" resultType="int" order="BEFORE">
			select MVY_MOVIE_NO_SEQ.NEXTVAL FROM DUAL
		</selectKey>
			INSERT INTO MVY_MOVIE
			VALUE(MOVIE_NO, MOVIE_TITLE, MOVIE_PRDTYEAR, MOVIE_NATION, MOVIE_DIRECTOR,
				MOVIE_RUNTIME, MOVIE_GRADE, MOVIE_PRICE, MOVIE_CREDATE, MOVIE_MODDATE, MOVIE_RATE)
			VALUES(#{movieNo}, #{movieTitle}, #{prdtYear}, #{nation}, #{director}, #{runtime}
			, #{grade}, #{price}, '1', '1', #{rate})
	</insert>
	
	<!-- 영화포토에 사진 추가(파일업로드) -->
	<insert id="insertFile" parameterType="movieDto">
		INSERT INTO MVY_MOVIE_PHOTO
		(IDX, PARENT_SEQ, ORIGINAL_FILE_NAME,
		STORED_FILE_NAME, FILE_SIZE, CRE_DATE)
		VALUES
		(MVY_MOVIE_PHOTO_SEQ.NEXTVAL, #{parentSeq}, #{original_file_name},
		 #{stored_file_name}, #{file_size}, SYSDATE)
	</insert>
	
<!-- 	영화리스트 -->
	<select id="movieSelectList" resultMap="movieResultMap">
		SELECT MV.MOVIE_NO, MV.MOVIE_TITLE, MV.MOVIE_DIRECTOR, MV.MOVIE_CREDATE
		   FROM (
		        SELECT ROWNUM RNUM, M.MOVIE_NO, M.MOVIE_TITLE
		      , M.MOVIE_DIRECTOR, M.MOVIE_CREDATE
		        FROM (
	                SELECT MOVIE_NO, MOVIE_TITLE, MOVIE_DIRECTOR, MOVIE_CREDATE
	         	   	   FROM MVY_MOVIE
	         	   	   <include refid="search"></include>
			           ORDER BY MOVIE_NO ASC) M
      				) MV
		WHERE MV.RNUM BETWEEN #{start} AND #{end}
	</select>		
	
<!-- 	영화수 -->
	<select id="movieSelectTotalCount" resultType="java.lang.Integer" parameterType="map">
		SELECT COUNT(*)
		FROM MVY_MOVIE
		<include refid="search"></include>
	</select>
	
	<select id="movieSelectOne" parameterType="int"
		resultMap="movieResultMap">
		SELECT MOVIE_NO, MOVIE_TITLE, MOVIE_PRDTYEAR, MOVIE_NATION
		, MOVIE_DIRECTOR, MOVIE_RUNTIME, MOVIE_GRADE, MOVIE_PRICE, MOVIE_CREDATE
		FROM MVY_MOVIE
		WHERE MOVIE_NO = #{movieNo}
	</select>	
	
	<select id="fileselectList" parameterType="int" resultType="map">
		SELECT IDX, ORIGINAL_FILE_NAME, STORED_FILE_NAME,
		ROUND(FILE_SIZE/1024, 1) AS FILE_SIZE
		FROM MVY_MOVIE_PHOTO
		WHERE PARENT_SEQ = #{movieNo}
	</select>
	
	<update id="movieUpdateOne" parameterType="movieDto">
		UPDATE MVY_MOVIE
		<set>
			<if test="movieTitle != ''">MOVIE_TITLE = #{movieTitle},</if>
			<if test="prdtYear != ''">MOVIE_PRDTYEAR = #{prdtYear},</if>
			<if test="nation != ''">MOVIE_NATION = #{nation},</if>
			<if test="director != ''">MOVIE_DIRECTOR = #{director},</if>
			<if test="runtime != ''">MOVIE_RUNTIME = #{runtime},</if>
			<if test="grade != ''">MOVIE_GRADE = #{grade},</if>
			<if test="price != ''">MOVIE_PRICE = #{price}</if>
<!-- 			MOD_DATE = SYSDATE -->
		</set>
		WHERE MOVIE_NO = #{movieNo}
	</update>
	
	<delete id="movieDeleteOne" parameterType="int">
		DELETE FROM MVY_MOVIE
		WHERE MOVIE_NO = #{movieNo}
	</delete>
	
	
	
</mapper>